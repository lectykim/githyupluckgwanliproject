<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Sidebar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        /* ì „ì²´ í˜ì´ì§€ ì„¤ì • */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            height: 100%;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #111;
            padding-top: 20px;
        }

        /* ì‚¬ì´ë“œë°” ë§í¬ ìŠ¤íƒ€ì¼ */
        .sidebar p {
            padding: 10px 15px;
            text-decoration: none;
            font-size: 18px;
            color: white;
            display: block;
        }

        /* ì‚¬ì´ë“œë°” ë§í¬ì— hover íš¨ê³¼ ì¶”ê°€ */
        .sidebar p:hover {
            background-color: #575757;
        }

        /* ë©”ì¸ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” ìŠ¤íƒ€ì¼ */
        .topnav {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            height: 50px;
            background-color: #333;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding-right: 20px;
            color: white;
        }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .topnav button {
            background-color: #575757;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 16px;
        }

        .topnav button:hover {
            background-color: #444;
        }

        /* ë©”ì¸ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            margin-top: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 70px);
        }

        /* ë°© ìƒì„±í•˜ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .create-room-btn {
            padding: 15px 30px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
        }

        .create-room-btn:hover {
            background-color: #218838;
        }

        .modal {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë‹¬ì„ ìˆ¨ê¹€ */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ë°°ê²½ */
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 30%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .test-text-viewer{
            display: flex;
            height:200px;
        }


        .button-list {
            list-style: none; /* ë¶ˆí•„ìš”í•œ ì  ë¦¬ìŠ¤íŠ¸ ì œê±° */
            padding: 0;
            margin: 0;
        }

        .button-list li {
            margin-bottom: 10px; /* ë²„íŠ¼ ê°„ ê°„ê²© */
        }

        .button-item {
            display: inline-block;  /* ì¸ë¼ì¸ ìš”ì†Œë¥¼ ë¸”ë¡ì²˜ëŸ¼ í‘œì‹œ */
            padding: 10px 20px;  /* ë²„íŠ¼ì˜ ì•ˆìª½ ì—¬ë°± */
            background-color: #4CAF50; /* ë²„íŠ¼ ë°°ê²½ìƒ‰ (ì´ˆë¡ìƒ‰) */
            color: white;  /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
            text-decoration: none; /* ë§í¬ì˜ ë°‘ì¤„ ì œê±° */
            border-radius: 5px;  /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            border: 1px solid transparent; /* í…Œë‘ë¦¬ ì¶”ê°€ */
            font-size: 16px;  /* ê¸€ì í¬ê¸° */
            cursor: pointer;  /* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ í¬ì¸í„° í‘œì‹œ */
            transition: background-color 0.3s ease, border 0.3s ease; /* í˜¸ë²„ ì‹œ ì• ë‹ˆë©”ì´ì…˜ */
        }

        .button-item:hover {
            background-color: #45a049; /* í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ ë³€ê²½ */
            border: 1px solid #4CAF50; /* í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½ */
        }



        /* ë°© ìƒì„± í¼ ìŠ¤íƒ€ì¼ */
        .room-form {
            display: none; /* ì²˜ìŒì—ëŠ” ìˆ¨ê¹€ */
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .chatting-global-container{
            display: none;
        }

        .profile-container {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            padding: 20px;
            max-width: 600px;
            margin: auto;
        }

        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 20px;
        }

        .profile-details {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .profile-bio {
            font-size: 16px;
            color: #555;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        input[type="submit"] {
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        input[type="submit"]:hover {
            background-color: #218838;
        }

        #chat-container {
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
        }
        #input-container {
            display: flex;
            margin-top: 10px;
        }
        #chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #send-button {
            padding: 10px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            margin-left: 5px;
            cursor: pointer;
        }
        #send-button:hover {
            background-color: #0056b3;
        }


        /* í˜ì´ì§€ì˜ ë°˜ì‘í˜• ì„¤ì • */
        @media screen and (max-width: 600px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .sidebar a {
                float: left;
                padding: 15px;
                text-align: center;
            }

            .main-content {
                margin-left: 0;
            }
            .topnav {
                left: 0;
                justify-content: center;
            }
        }
    </style>
</head>
<body>

<!-- ì‚¬ì´ë“œë°” -->
<div class="sidebar" >
    <div>
        <p onclick="showMakeButtonForm()">
            <span>Make Room Button</span>
        </p>
    </div>
    <div th:each="room : ${roomDtoList}">
        <p th:onclick="'connectChatting(' + ${room.roomId} + ')'">
            <span th:text="${room.title}"></span><span th:id="'room-'+${room.roomId}" th:text="'('+${room.getNotReadMessageCount()}+')'" style="color:red;"></span>
        </p>
    </div>
</div>

<!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<div class="topnav">
    <button onclick="openEventModal()">
        ğŸ”” Notifications
            <span id="notification"></span>
    </button>
    <button onclick="window.location.href='/dashboard/mypage'">My Page</button>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<!-- ë©”ì¸ ì½˜í…ì¸  -->
<!-- ë©”ì¸ ì½˜í…ì¸  -->
<div class="main-content">
    <button class="create-room-btn" id="createRoomBtn" onclick="showRoomForm()">Create Room</button>

    <div class="profile-container">
        <img class="profile-image" id="profile-image" src="" alt="Profile Image">
        <div class="profile-details">
            <div class="profile-name" id="profile-name"></div>
            <div class="profile-bio" id="profile-bio"></div>
        </div>

    </div>


    <!-- ë°© ìƒì„± í¼ -->
    <div class="room-form" id="roomForm">
        <div id="createRoomForm">
            <label for="title">Room Title:</label>
            <input type="text" id="title" name="title" placeholder="Enter room title" required>

            <label for="maxMembers">Max Members:</label>
            <input type="number" id="maxMembers" name="maxMembers" placeholder="Enter max members" required>

            <label for="repository"> Repository : </label>
            <input type="text" id="repository" name="repository" placeholder="input target repository" required>

            <label for="owner">Owner : </label>
            <input type="text" id="owner" name="owner" placeholder="input target owner" required>
            <input type="submit" onclick="createRoomRequest()" value="Create Room">
        </div>
    </div>
    <div>
        <!-- ëª¨ë‹¬ êµ¬ì¡° -->
        <div id="eventModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="removeModal(3)">&times;</span>
                <div id="event-container"></div>
            </div>
        </div>
    </div>
    <div class="chatting-global-container" id="chatting-global-container">
        <div id="chat-container"></div>

        <div id="info-data">
            ë°©ì¥ì´ ë¸ŒëŸ°ì¹˜ or ì»¤ë°‹ ì •ë³´ë¥¼ ì„ íƒí•  ë•Œ ë™ê¸°í™”ë©ë‹ˆë‹¤.
        </div>
        <div id="test-text-viewer" class="test-text-viewer">
            <div id="branch-title">ë¸ŒëŸ°ì¹˜</div>
            <ul id="branch-data" class="button-list"></ul>

            <div id="commit-title">ì»¤ë°‹</div>
            <ul id="commit-data" class="button-list"></ul>
        </div>
        <!-- ì˜¤ë¥¸ìª½ì— ë°°ì¹˜í•  ë²„íŠ¼ë“¤ì„ í¬í•¨í•œ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
        <div id="button-container" class="button-container">
            <button onclick="inviteMember()" id="invite-button">ë©¤ë²„ ì´ˆëŒ€í•˜ê¸°</button>
            <button onclick="getCurrentMember()" id="view-current-member-button">í˜„ì¬ ë©¤ë²„ ë³´ê¸°</button>
            <button onclick="gitSetting()" id="git-setting-button">Git ì„¤ì • ë³€ê²½í•˜ê¸°</button>
        </div>


        <!-- ëª¨ë‹¬ êµ¬ì¡° -->
        <div id="inviteMemberModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="removeModal(0)">&times;</span>
                <h2 >ì´ˆëŒ€ì ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.</h2>
                <input type="text" id="invite-email" name="invite-email" placeholder="Enter invite user email" required>
                <button onclick="callInvite()">ì „ì†¡</button>
            </div>
        </div>

        <!-- ëª¨ë‹¬ êµ¬ì¡° -->
        <div id="getCurrentMemberModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="removeModal(1)">&times;</span>
                <h2 >í˜„ì¬ ë°©ì˜ ë©¤ë²„ì…ë‹ˆë‹¤.</h2>
            </div>
        </div>

        <!-- ëª¨ë‹¬ êµ¬ì¡° -->
        <div id="gitSettingModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="removeModal(2)">&times;</span>
                <h2 >í˜‘ì—…ì‹œ ê´€ì¸¡í•˜ê³ ì‹¶ì€ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</h2>
                <input type="text" id="git-repository" name="git-repository" placeholder="Enter git repository and branch" required>
                <button onclick="callRepository()">ì „ì†¡</button>
            </div>
        </div>



        <div id="input-container">
            <input type="text" id="chat-input" placeholder="ì±„íŒ…ì„ ì…ë ¥í•˜ì„¸ìš”..." />
            <button id="send-button" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

</div>
<script type="text/javascript" th:src="@{/js/common.js}">

</script>
<script>
    const form = document.getElementById('roomForm');
    const createRoomButton = document.getElementById('createRoomBtn');
    const chattingForm = document.getElementById('chatting-global-container');
    const chatContainer = document.getElementById('chat-container');
    const eventContainer = document.getElementById('event-container');


    const span = document.getElementsByClassName('close')[0];
    let owner;
    let currentRoomNum = 0;
    let roomDtoList = /*[[${roomDtoList}]]*/'[]';
    let currentMemberDTO = /*[[${currentMemberDTO}]]*/{};
    let stompClients = {};
    let currentEvents = {};
    let currentClientChannelId = null;


    const onError = (error)=>{
        console.error(error);
    }


    const onMessageReceived = (data)=>{
        console.log(data);
        const chat = JSON.parse(data.body);

        if(chat.type==='CHAT'&&chat.channelId==currentRoomNum){
            //Chat containerì˜ childì— ì¶”ê°€
            addChildChatting(chat);
            //Read Posë¥¼ ì—…ë°ì´íŠ¸ í•˜ëŠ” í•¨ìˆ˜
            updateReceivePos(chat);
        }else if((chat.type==='COMMIT'||chat.type==='BRANCH')&&chat.channelId==currentRoomNum){
            showGithubData(chat);
        }else{
            //ì•Œë¦¼ ë™ê¸°í™”
            notificationSynchronization(chat);
        }
    }
    const showGithubData = (data)=>{

        if(data.type==='BRANCH'){
            const branchDetailURL = 'http://localhost:8080/api/v1/github-api/get-branch-detail';
            const roomDto = findRoomDto(currentRoomNum);
            const branchQueryParam = {
                owner:roomDto.owner,
                repo:roomDto.repository,
                branch:data.data
            }
            const branchQueryString = new URLSearchParams(branchQueryParam).toString()
            const branchApiReqUrl = `${branchDetailURL}?${branchQueryString}`;
            fetch(branchApiReqUrl,{
                method:'GET',
            })
                .then((response)=>{
                    if(response.ok){
                        return response.text();
                    }else{
                        console.log(response);
                    }
                })
                .then((data)=>{
                    const newData = JSON.parse(data);
                    document.getElementById('info-data').textContent = newData.name;
                })
        }else{
            const commitDetailURL = 'http://localhost:8080/api/v1/github-api/get-commit-detail';
            const roomDto = findRoomDto(currentRoomNum);
            const commitQueryParam = {
                owner:roomDto.owner,
                repo:roomDto.repository,
                sha:data.data
            }
            const commitQueryString = new URLSearchParams(commitQueryParam).toString()
            const commitApiReqUrl = `${commitDetailURL}?${commitQueryString}`;
            fetch(commitApiReqUrl,{
                method:'GET',
            })
                .then((response)=>{
                    if(response.ok){
                        return response.text();
                    }else{
                        console.log(response);
                    }
                })
                .then((data)=>{
                    const newData = JSON.parse(data);
                    let shaData = '';
                    newData.files.forEach((res)=>{
                        shaData += res.patch;
                    })
                    document.getElementById('info-data').textContent = shaData;
                })
        }
    }

    const updateReceivePos = (chat)=>{
        const chattingData = {
            sender:currentMemberDTO.email,
            channelId:currentRoomNum.toString(),
            type:'RECEIVE',
            messageNum:chat.messageNum
        }
        stompClients[currentRoomNum].send(
            "/pub/receive/"+currentRoomNum,
            {},
            JSON.stringify(chattingData)
        )
    }


    const logout = ()=>{
        window.location.href = 'http://localhost:8080/logout';
    }

    const inviteMember = ()=>{
        const modal = document.getElementById('inviteMemberModal');
        modal.style.display = 'block';
    }

    const getCurrentMember = ()=>{
        const modal = document.getElementById('getCurrentMemberModal');
        modal.style.display = 'block'
    }

    const sendMessage = ()=>{
        const message = document.getElementById('chat-input').value;
        const chattingData = {
            sender:currentMemberDTO.email,
            channelId:currentRoomNum.toString(),
            type:'CHAT',
            data:message
        }
        stompClients[currentRoomNum].send(
            "/pub/chat/"+currentRoomNum,
            {},
            JSON.stringify(chattingData)
        )
    }
    const openEventModal = () => {
        const modal = document.getElementById('eventModal');
        modal.style.display = 'block';
        eventContainer.innerHTML=''
        currentEvents.forEach((data) => {
            // ë©”ì‹œì§€ ìš”ì†Œ ìƒì„±
            const messageElement = document.createElement('div');
            messageElement.textContent = data.title + " ë°©ì— ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤. ";

            // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìƒì„±
            const buttonContainer = document.createElement('div');

            // ìˆ˜ë½ ë²„íŠ¼ ìƒì„±
            const acceptButton = document.createElement('button');
            acceptButton.textContent = 'ìˆ˜ë½';
            acceptButton.onclick = () => {
                // ìˆ˜ë½ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰í•  ì½”ë“œ
                fetch('http://localhost:8080/api/v1/room-api/accept-invite',{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({roomId:data.roomId})
                })
                    .then((response)=>{
                        if(response.ok&&response.status===200){
                            alert('ë°© ìˆ˜ë½ì— ì„±ê³µ í–ˆìŠµë‹ˆë‹¤!');
                            window.location.reload();
                        }else{
                            alert('ë°© ìˆ˜ë½ì— ì‹¤íŒ¨ í–ˆìŠµë‹ˆë‹¤.')
                            window.location.reload();
                        }
                    })

            };

            // ê±°ì ˆ ë²„íŠ¼ ìƒì„±
            const declineButton = document.createElement('button');
            declineButton.textContent = 'ê±°ì ˆ';
            declineButton.onclick = () => {
                // ê±°ì ˆ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰í•  ì½”ë“œ
                fetch('http://localhost:8080/api/v1/room-api/deny-invite',{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({roomId:data.roomId})
                })
                    .then((response)=>{
                        if(response.ok&&response.status===200){
                            alert('ë°© ê±°ì ˆì— ì„±ê³µ í–ˆìŠµë‹ˆë‹¤!');
                            window.location.reload();
                        }else{
                            alert('ë°© ê±°ì ˆì— ì‹¤íŒ¨ í–ˆìŠµë‹ˆë‹¤.')
                            window.location.reload();
                        }
                    })


            };

            // ë²„íŠ¼ë“¤ì„ ë²„íŠ¼ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
            buttonContainer.appendChild(acceptButton);
            buttonContainer.appendChild(declineButton);

            // ë©”ì‹œì§€ì™€ ë²„íŠ¼ ì»¨í…Œì´ë„ˆë¥¼ ëª¨ë‹¬ì— ì¶”ê°€
            messageElement.appendChild(buttonContainer);
            eventContainer.appendChild(messageElement);
        });
    };

    const callInvite = ()=>{
        const email = document.getElementById('invite-email').value;
        if(!emailCheck(email)){
            alert('í˜•ì‹ì— ë§ëŠ” ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return false;
        }
        fetch('http://localhost:8080/api/v1/room-api/invite-other-member',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify({email:email,roomId:currentRoomNum})
        })
            .then((response)=>{
            if(response.ok&&response.status===200){
                alert('ì´ˆëŒ€ì— ì„±ê³µ í–ˆìŠµë‹ˆë‹¤.');
            }else if(response.status === 400){
                alert('ì´ˆëŒ€ì— ì‹¤íŒ¨ í–ˆìŠµë‹ˆë‹¤.');
            }
        })
            .catch((error)=>{
                console.error(error)
            });

    }

    const callRepository = ()=>{

    }
    const gitSetting = () => {
        const modal = document.getElementById('gitSettingModal');
        modal.style.display = 'block';
    }
    const removeModal = (num)=>{
        if(num === 0){
            const modal = document.getElementById('inviteMemberModal');
            modal.style.display = 'none';
        }else if(num === 1){
            const modal = document.getElementById('getCurrentMemberModal');
            modal.style.display = 'none'
        }else if(num === 2){
            const modal = document.getElementById('gitSettingModal');
            modal.style.display = 'none';
        }else{
            const modal = document.getElementById('eventModal');
            modal.style.display = 'none';
        }

    }

    const notificationSynchronization = (data)=>{
        const channelStr = 'room-'+data.channelId;
        let channelNum = document.getElementById(channelStr).textContent;
        let number = Number(channelNum.match(/\d+/)[0]);
        number += 1;
        document.getElementById(channelStr).textContent='(' + number + ')';
    }

    const getNotification = ()=>{
        fetch('http://localhost:8080/api/v1/room-api/get-all-event',{
            method:'GET',
            headers:{
                'Content-Type':'application/json'
            },
        })
            .then((response)=>{
                console.log(response);
                if(response.ok){
                    return response.json();
                }else{
                    console.log(response);
                }
            })
            .then((data)=>{
                console.log(data);
                const count = data.inviteRoomDTOList.length;
                document.getElementById('notification').textContent = count > 0 ? `(${count})` : '';
                currentEvents = data.inviteRoomDTOList;
                roomDtoList = data.currentRoomDTOList;
                currentMemberDTO = data.currentMemberDTO;
                console.log(roomDtoList);
                //roomDtoList ê°€ì ¸ì˜¤ê¸°
                for(let i=0;i<roomDtoList.length;i++){
                    let socket = new SockJS('/ws');
                    stompClients[roomDtoList[i].roomId] = new Stomp.over(socket);
                    stompClients[roomDtoList[i].roomId].connect({},()=>{
                        stompClients[roomDtoList[i].roomId].subscribe("/sub/chat/"+roomDtoList[i].roomId,onMessageReceived);
                    },onError);

                }
            })
        fetch('http://localhost:8080/api/v1/github-api/user',{
            method:'GET',
            headers:{
                'Content-Type':'application/json',
                'Cache-Control': 'no-cache',
            },
        })
            .then((response)=>{
                console.log(response);
                if(response.ok){
                    return response.text();
                }else{
                    console.log(response);
                }
            })
            .then((text)=>{
                const data = JSON.parse(text);
                console.log(data);
                owner = data.login;
                document.getElementById('profile-image').src = data.avatar_url;
                document.getElementById('profile-name').textContent = data.login;
                document.getElementById('profile-bio').textContent = data.bio;
            })
            .catch((error)=>{
                console.error(error);
            })

    }

    const showMakeButtonForm= ()=>{
        createRoomButton.style.display='block';
    }
    const showRoomForm = ()=>{
        form.style.display = 'block'; // í¼ì„ ë³´ì´ë„ë¡ ì„¤ì •
    }

    const hideChattingContent = ()=>{
        createRoomButton.style.display='none';
        form.style.display='none';
    }

    const createRoomRequest = ()=>{
        const title = document.getElementById('title').value;
        if(!checkTitle(title)){
            alert("í˜•ì‹ì— ë§ëŠ” titleì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
            return false;
        }
        const maxMember = parseInt(document.getElementById('maxMembers').value);
        if(!checkMaxMember(maxMember)){
            alert('í˜•ì‹ì— ë§ëŠ” maxMembersë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return false;
        }
        const repository = document.getElementById('repository').value;
        if(!isNotEmpty(repository)){
            alert('íƒ€ê²Ÿ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”');
            return false;
        }
        const owner = document.getElementById('owner').value;
        if(!isNotEmpty(owner)){
            alert("íƒ€ê²Ÿ ì˜¤ë„ˆë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”");
            return false;
        }

        fetch('/api/v1/room-api/create',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify({maxMember,title,repository,owner})
        })
            .then((response)=>{
                if(response.ok&&response.status===200){
                    window.location.reload();
                }else if(response.status === 400){
                    alert('ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch((error)=>{
                console.error(error)
            });
    }

    const connectChatting = (roomNum)=>{
        currentRoomNum = roomNum;
        roomDtoList.forEach((data)=>{
            if(data.roomId === roomNum){
                console.log(data);
                data.memberToRoomDTOList.forEach((memberToRoomDTO)=>{
                    console.log(memberToRoomDTO)
                    if(memberToRoomDTO.roomId === roomNum&&
                        memberToRoomDTO.master&&
                        memberToRoomDTO.memberId === currentMemberDTO.memberId){
                        showBeforeChat(data);
                        masterSettingForm(data);
                        hideChattingContent();
                        chattingForm.style.display='block';
                        syncReadPos(roomNum);
                        return true;
                    }
                });
            }
        })
        showBeforeChat(findRoomDto(roomNum));
        hideChattingContent()
        chattingForm.style.display='block'
        syncReadPos(roomNum);



    }

    const syncReadPos = (roomNum)=>{
        fetch('http://localhost:8080/api/v1/room-api/sync-room-read-pos',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify({roomId:roomNum})
        })
            .then((response)=>{
                if(response.ok){
                    document.getElementById('room-'+roomNum).textContent='(0)';
                }else{
                    console.log(response);
                }
            })
    }

    const findRoomDto = (roomNum) => {
        return roomDtoList.find(data => data.roomId === roomNum) || null;
    };

    const showBeforeChat = (data)=>{
        data.messageHistory.forEach((message)=>{
            const messageElement = document.createElement('div')
            messageElement.textContent = message
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight; // ìŠ¤í¬ë¡¤ì„ ê°€ì¥ ì•„ë˜ë¡œ
        })
    }
    const slaveSettingForm = ()=>{
        document.getElementById('info-data').textContent='';
    }

    const masterSettingForm = (data)=>{
        slaveSettingForm()
        const branchApiCallUrl = 'http://localhost:8080/api/v1/github-api/get-branch-list';
        const branchParam = {
            owner:data.owner,
            repo:data.repository
        }
        const branchQueryString = new URLSearchParams(branchParam).toString()
        const branchApiReqUrl = `${branchApiCallUrl}?${branchQueryString}`;
        fetch(branchApiReqUrl,{
            method:'GET',
        })
            .then((response)=>response.text())
            .then((text)=>{


                const textIterator = JSON.parse(text);
                const branchData = document.getElementById('branch-data');
                textIterator.forEach((data)=>{

                    const branchChild = document.createElement('li');
                    branchChild.textContent=data.name;
                    branchChild.className='button-item'
                    branchChild.onclick=()=>branchChildOnClick(data.name);

                    branchData.appendChild(branchChild);
                })

            })
        const commitApiCallUrl = 'http://localhost:8080/api/v1/github-api/get-commit-list';
        const commitParam = {
            owner:data.owner,
            repo:data.repository
        };
        const commitQueryString = new URLSearchParams(commitParam).toString()
        const commitApiReqUrl = `${commitApiCallUrl}?${commitQueryString}`;
        fetch(commitApiReqUrl,{
            method:'GET',
        })
            .then((response)=>response.text())
            .then((text)=>{

                let textData = '';
                console.log(text);
                const textIterator = JSON.parse(text);
                const commitData = document.getElementById('commit-data');

                textIterator.forEach((data)=>{

                    const commitChild = document.createElement('li');
                    commitChild.textContent = data.commit.message;
                    commitChild.className='button-item'
                    commitChild.onclick = ()=>commitChildOnClick(data.sha)
                    commitData.appendChild(commitChild);
                })
            })
    }

    const branchChildOnClick = (name)=>{

        const chattingData = {
            sender:currentMemberDTO.email,
            channelId:currentRoomNum.toString(),
            type:'BRANCH',
            data:name
        }
        stompClients[currentRoomNum].send(
            "/pub/github/"+currentRoomNum,
            {},
            JSON.stringify(chattingData)
        )
    }

    const commitChildOnClick = (sha)=>{
        const chattingData = {
            sender:currentMemberDTO.email,
            channelId:currentRoomNum.toString(),
            type:'COMMIT',
            data:sha
        }
        stompClients[currentRoomNum].send(
            "/pub/github/"+currentRoomNum,
            {},
            JSON.stringify(chattingData)
        )
    }


    const addChildChatting = (message)=>{
        const messageElement = document.createElement('div')
        messageElement.textContent = message.sender + ' : ' + message.data
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight; // ìŠ¤í¬ë¡¤ì„ ê°€ì¥ ì•„ë˜ë¡œ
    }


    window.onload=getNotification
</script>
</body>
</html>
